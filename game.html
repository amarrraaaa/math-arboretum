<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Matematika Kelas 3 SD</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Comic Neue', cursive; background-color: #f0fdf4; user-select: none; }
        @keyframes float { 0%{transform:translateY(0)} 50%{transform:translateY(-10px)} 100%{transform:translateY(0)} }
        .float-anim{animation:float 3s ease-in-out infinite}
        @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }
        .pop-anim{animation:pop .3s ease-in-out}
        .zone-card{transition:all .3s ease;box-shadow:0 4px 6px rgba(0,0,0,.1);cursor:pointer}
        .zone-card:hover{transform:translateY(-5px);box-shadow:0 10px 15px rgba(0,0,0,.15);border-color:#22c55e}
        .draggable-item{cursor:grab;transition:all .2s;touch-action:none}
        .draggable-item:active{cursor:grabbing;transform:scale(1.05)}
        .draggable-item.dragging{opacity:.5;border:2px dashed #15803d}
        .drop-slot{transition:all .3s;background-color:#f0fdf4;border:2px dashed #86efac}
        .drop-slot.drag-over{background-color:#dcfce7;border-color:#16a34a;transform:scale(1.02)}
        .ruler{background:repeating-linear-gradient(90deg,#fbbf24,#fbbf24 2px,transparent 2px,transparent 20px);border:2px solid #b45309;height:40px;position:relative}
        .modal{background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
        .bundle-card{width:120px;min-height:140px;background:linear-gradient(135deg,#f0fdf4,#bbf7d0);border:2px solid #86efac;border-radius:18px;box-shadow:inset 0 2px 6px rgba(0,0,0,.08);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:10px}
        .mini-bamboo{width:16px;height:46px;border-radius:999px;background:linear-gradient(180deg,#22c55e,#15803d);border:1px solid rgba(0,0,0,.1);position:relative}
        .mini-bamboo::after{content:'';position:absolute;top:18px;left:0;right:0;height:4px;background:rgba(255,255,255,.4)}
        .bamboo-chip{width:28px;height:70px;border-radius:18px;background:linear-gradient(180deg,#4ade80,#15803d);border:2px solid #065f46;box-shadow:inset 0 3px 6px rgba(255,255,255,.3)}
        .basket-drop{background:repeating-linear-gradient(45deg,rgba(251,191,36,.2),rgba(251,191,36,.2) 10px,rgba(255,255,255,.2) 10px,rgba(255,255,255,.2) 20px)}
        .symbol-token{width:60px;height:60px;border-radius:18px;border:2px solid #bfdbfe;background:#eff6ff;color:#1d4ed8;display:flex;align-items:center;justify-content:center;font-size:1.75rem;font-weight:700;box-shadow:0 4px 10px rgba(59,130,246,.15)}
        .group-board{min-width:140px;min-height:160px;background:#ecfccb;border:3px solid #84cc16;border-radius:24px;padding:16px;display:flex;flex-wrap:wrap;justify-content:center;gap:6px;position:relative}
        .compare-slot{width:100px;height:100px;border-radius:24px;background:linear-gradient(135deg, #fff7ed, #fef3c7);border:4px dashed #f59e0b;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(245,158,11,0.2)}
        .compare-slot.has-symbol{border-style:solid;border-color:#22c55e;background:linear-gradient(135deg, #dcfce7, #bbf7d0);box-shadow:0 8px 20px rgba(34,197,94,0.3)}
        .feedback-glow-success{box-shadow:0 0 25px rgba(34,197,94,.45)}
        .feedback-glow-fail{box-shadow:0 0 25px rgba(239,68,68,.35)}
        .custom-scrollbar::-webkit-scrollbar{height:10px}
        .custom-scrollbar::-webkit-scrollbar-track{background:#e5e7eb;border-radius:999px}
        .custom-scrollbar::-webkit-scrollbar-thumb{background:#34d399;border-radius:999px}
        .shape-card{width:140px;height:140px;border-radius:1rem;background:#ecfeff;border:3px solid #22d3ee;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease,border-color .15s ease;padding:8px}
        .shape-card:hover{transform:translateY(-3px);box-shadow:0 10px 18px rgba(14,116,144,.25)}
        .shape-card.selected{border-color:#3b82f6;box-shadow:0 0 15px rgba(59,130,246,.4)}
        .shape-card.correct{border-color:#22c55e;box-shadow:0 0 20px rgba(34,197,94,.6)}
        .shape-card.wrong{border-color:#ef4444;box-shadow:0 0 20px rgba(239,68,68,.55)}
        .shape-visual{width:80px;height:80px;display:flex;align-items:center;justify-content:center}
        .shape-label{margin-top:8px;text-align:center;font-size:.75rem;font-weight:700;color:#0f172a}
        .btn-press{transform:scale(.97) translateY(1px)}
        .zone-pop{animation:zonePop 260ms ease-out}
        @keyframes zonePop{0%{transform:scale(1) translateY(0)} 40%{transform:scale(1.04) translateY(-4px)} 100%{transform:scale(1) translateY(0)}}
        @keyframes pulse-glow{0%,100%{box-shadow:0 0 10px rgba(245,158,11,0.3)}50%{box-shadow:0 0 25px rgba(245,158,11,0.6)}}
        .compare-slot:not(.has-symbol){animation:pulse-glow 2s ease-in-out infinite}
        
        /* Floating Home Button */
        #floating-home-btn{
            animation: float-bounce 3s ease-in-out infinite;
        }
        @keyframes float-bounce{
            0%, 100%{transform: translateY(0)}
            50%{transform: translateY(-5px)}
        }
        #floating-home-btn:hover{
            animation: none;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800">

<header class="bg-green-600 text-white p-4 shadow-lg sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="flex flex-col">
                <div class="flex items-center gap-2">
                    <span class="text-2xl md:text-3xl">üéã</span>
                    <h1 class="text-lg md:text-2xl font-bold">Arboretum Bambu</h1>
                </div>
                <p class="text-xs md:text-sm text-green-100 font-medium ml-1">Matematika Kelas 3 Sekolah Dasar</p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <div class="text-right hidden md:block">
                <div class="w-32 h-4 bg-green-800 rounded-full mt-1 overflow-hidden border border-green-400">
                    <div id="xp-bar" class="h-full bg-yellow-400 w-0 transition-all duration-1000"></div>
                </div>
            </div>
            <div class="w-10 h-10 bg-white text-green-700 rounded-full flex items-center justify-center border-2 border-green-200 shadow-inner">
                <span id="level-indicator" class="font-bold text-lg">1</span>
            </div>
        </div>
    </div>
</header>

<main class="container mx-auto p-4 pb-20">
    <div id="welcome-msg" class="bg-green-50 border-l-4 border-green-500 p-4 mb-8 rounded shadow-sm">
        <div class="flex items-start justify-between">
            <div>
                <h2 class="font-bold text-green-800 text-lg">Selamat Datang, Petualang Cilik! üåø</h2>
                <p class="text-green-700">Jelajahi hutan bambu dan selesaikan tantangan matematika untuk menumbuhkan tunas bambu.</p>
            </div>
            <div class="hidden md:flex items-center gap-2 bg-green-100 px-3 py-1 rounded-full border border-green-300">
                <span class="text-lg">üìö</span>
                <span class="text-sm font-bold text-green-800">Kelas 3 SD</span>
            </div>
        </div>
    </div>

    <section id="map-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div onclick="GameEngine.handleZoneClick('sorting', event)" class="zone-card bg-white rounded-xl overflow-hidden border-2 border-green-100 relative group">
            <div class="bg-green-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-green-800 text-xl">1. Lembah Angka</h3>
                <span class="text-2xl float-anim">üî¢</span>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Seret bambu untuk menuntaskan tantangan angka seru.</p>
                <div class="inline-block bg-green-500 text-white px-4 py-2 rounded-full text-sm font-bold group-hover:bg-green-600">Mulai Petualangan</div>
            </div>
        </div>

        <div onclick="GameEngine.handleZoneClick('equation', event)" class="zone-card bg-white rounded-xl overflow-hidden border-2 border-green-100 relative group">
            <div class="bg-blue-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-blue-800 text-xl">2. Bengkel Bambu</h3>
                <span class="text-2xl float-anim">üîß</span>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Susun potongan bambu menjadi kalimat matematika yang benar.</p>
                <div class="inline-block bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-bold group-hover:bg-blue-600">Mulai Petualangan</div>
            </div>
        </div>

        <div onclick="GameEngine.handleZoneClick('measurement', event)" class="zone-card bg-white rounded-xl overflow-hidden border-2 border-green-100 relative group">
            <div class="bg-yellow-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-yellow-800 text-xl">3. Taman Ukur</h3>
                <span class="text-2xl float-anim">üìè</span>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Ukur panjang dan berat batang bambu dengan tepat.</p>
                <div class="inline-block bg-yellow-500 text-white px-4 py-2 rounded-full text-sm font-bold group-hover:bg-yellow-600">Mulai Petualangan</div>
            </div>
        </div>

        <div onclick="GameEngine.handleZoneClick('geometry', event)" class="zone-card bg-white rounded-xl overflow-hidden border-2 border-green-100 relative group">
            <div class="bg-teal-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-teal-800 text-xl">4. Galeri Pola Bambu</h3>
                <span class="text-2xl float-anim">üß©</span>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Amati sisi, sudut, dan ciri bangun datar dari pola bambu.</p>
                <div class="inline-block bg-teal-500 text-white px-4 py-2 rounded-full text-sm font-bold group-hover:bg-teal-600">Mulai Petualangan</div>
            </div>
        </div>

        <div onclick="GameEngine.handleZoneClick('data', event)" class="zone-card bg-white rounded-xl overflow-hidden border-2 border-green-100 relative group">
            <div class="bg-purple-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-purple-800 text-xl">5. Balai Panen</h3>
                <span class="text-2xl float-anim">üìä</span>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Baca tabel panen dan jawab pertanyaan petani.</p>
                <div class="inline-block bg-purple-500 text-white px-4 py-2 rounded-full text-sm font-bold group-hover:bg-purple-600">Mulai Petualangan</div>
            </div>
        </div>
    </section>

    <section id="game-area" class="hidden max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6 gap-3 flex-wrap">
            <button onclick="GameEngine.playClickAnd(GameEngine.backToMap, this)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold flex items-center">
                <span class="mr-2">‚¨ÖÔ∏è</span> Peta
            </button>
            <div class="flex flex-col items-center">
                <div id="game-title" class="text-xl font-bold text-green-800">Nama Permainan</div>
                <div id="question-progress" class="text-xs font-bold text-gray-500 hidden">Soal 1/10</div>
            </div>
            <button onclick="GameEngine.playClickAnd(GameEngine.reloadLevel, this)" class="bg-orange-100 hover:bg-orange-200 text-orange-700 px-4 py-2 rounded-lg font-bold">
                üîÑ Soal Baru
            </button>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border-4 border-green-100 p-6 min-h-[400px] relative">
            <div id="game-sorting" class="game-module hidden">
                <div class="text-center mb-6">
                    <p id="sorting-title" class="text-lg text-gray-700">Pilihan tantangan bambu.</p>
                    <p id="sorting-note" class="text-sm text-gray-500">Seret dan lepas objek bambu.</p>
                </div>
                <div id="sorting-container" class="flex flex-col md:flex-row justify-center items-center gap-4 py-8 min-h-[200px]"></div>
                <div class="text-center mt-8">
                    <button onclick="GameEngine.playClickAnd(SortingGame.checkAnswer, this)" class="bg-green-500 hover:bg-green-600 text-white text-lg font-bold py-3 px-8 rounded-full shadow-lg transform transition active:scale-95">Cek Tantangan!</button>
                </div>
            </div>

            <div id="game-equation" class="game-module hidden w-full">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold text-blue-800 mb-2">Kalimat Matematika</h3>
                    <p class="text-gray-600">Pilihlah kalimat matematika atau jawaban yang tepat sesuai cerita!</p>
                </div>
                <div class="flex flex-col md:flex-row gap-6 items-start">
                    <div class="w-full md:w-1/2 bg-blue-50 p-6 rounded-xl border-2 border-blue-100 min-h-[200px] flex flex-col items-center justify-center text-center relative">
                        <div id="equation-img-container" class="hidden mb-4 w-full max-w-[200px]">
                            <img id="equation-img" src="" alt="Ilustrasi Soal" class="rounded-lg shadow-md w-full h-auto border border-blue-200">
                        </div>
                        <p id="equation-question-text" class="text-lg md:text-xl font-bold text-blue-900 leading-relaxed"></p>
                    </div>
                    <div class="w-full md:w-1/2 flex flex-col justify-center gap-4" id="equation-options-container"></div>
                </div>
            </div>

            <div id="game-measurement" class="game-module hidden">
                <div class="text-center mb-2">
                    <p class="text-lg text-gray-700 font-bold" id="measure-question">Berapa ukuran bambu ini?</p>
                    <div id="measure-hint" class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg inline-block text-sm border border-yellow-300">‚ÜîÔ∏è <b>Geser (Scroll) penggaris ke kanan</b> untuk melihat ujung bambu!</div>
                </div>

                <div class="flex flex-col items-center justify-center py-4 space-y-6">
                    <div id="measure-length-game" class="w-full max-w-3xl mx-auto bg-white rounded-xl shadow-lg border-2 border-gray-300 overflow-hidden hidden">
                        <div class="overflow-x-auto custom-scrollbar relative" style="height: 220px;">
                            <div id="measure-canvas" class="relative h-full select-none" style="width: 1800px; background-color: #f9fafb;">
                                <div class="absolute top-0 bottom-0 w-1 bg-red-500 z-30" style="left: 50px;"></div>
                                <div class="absolute top-2 left-2 text-red-500 font-bold text-xs">Mulai (0)</div>

                                <div class="absolute top-12 left-[50px] h-20 z-10 flex items-center" style="width: 0px; transition: width 1s ease-out;" id="bamboo-obj">
                                    <div class="w-full h-full bg-gradient-to-r from-green-700 via-green-500 to-green-400 rounded-r-lg shadow-md border-y-2 border-r-2 border-green-800 relative overflow-hidden">
                                        <div class="absolute inset-0 opacity-30" style="background-image: repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(0,0,0,0.1) 40px, rgba(0,0,0,0.1) 42px);"></div>
                                        <div class="absolute top-2 bottom-4 left-0 right-0 bg-white opacity-20 rounded-full blur-sm"></div>
                                    </div>
                                    <div class="absolute right-0 top-full h-24 w-0.5 border-r-2 border-dashed border-red-500 opacity-60"></div>
                                </div>

                                <div class="absolute bottom-0 left-[50px] right-0 h-16 border-t-2 border-gray-800 bg-yellow-50 text-gray-800 font-mono" id="ruler-ticks"></div>
                            </div>
                        </div>
                    </div>

                    <div id="measure-weight-game" class="hidden flex flex-col items-center justify-center p-6 w-full max-w-xl">
                        <div class="relative w-96 h-96 bg-gray-100 rounded-full border-8 border-gray-300 shadow-2xl flex items-center justify-center z-10">
                            <div class="absolute inset-2 rounded-full bg-white border border-gray-200 shadow-inner" id="scale-face"></div>
                            <div id="scale-needle" class="absolute z-20 bg-red-600 shadow-sm" style="width: 4px; height: 180px; bottom: 50%; left: calc(50% - 2px); transform-origin: bottom center; clip-path: polygon(50% 0, 100% 100%, 0% 100%); transform: rotate(0deg); transition: transform 1.5s cubic-bezier(0.2, 0.8, 0.2, 1);"></div>
                            <div class="absolute w-5 h-5 bg-gray-800 rounded-full z-30 shadow-md border-2 border-gray-600"></div>
                            <div class="absolute top-10 text-5xl font-bold text-gray-100 select-none z-0">kg</div>
                        </div>
                        <div class="flex flex-col items-center z-0 -mt-1"><div class="w-4 h-8 bg-gray-400 border-x-2 border-gray-500"></div></div>
                        <div class="z-20 relative">
                            <div class="w-48 h-28 bg-amber-100 border-4 border-amber-300 rounded-b-3xl shadow-lg flex flex-col items-center justify-end p-2" style="background-image: radial-gradient(#d97706 1px, transparent 1px); background-size: 10px 10px;">
                                <div class="text-5xl absolute -top-10 animate-bounce">üéã</div>
                                <div id="scale-load-label" class="text-sm font-bold text-amber-800 bg-amber-200 px-3 py-1 rounded">Beban</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row items-center gap-4 bg-green-50 p-6 rounded-xl shadow-md border-2 border-green-200 w-full max-w-2xl justify-center" id="measure-answer-panel">
                        <label class="font-bold text-green-900 text-lg" id="measure-label">Panjangnya adalah:</label>
                        <div class="flex items-center gap-2" id="measure-input-wrap">
                            <input type="number" id="measure-input" step="0.5" class="border-2 border-green-400 rounded-lg px-4 py-2 w-32 text-center font-bold text-3xl focus:border-green-600 outline-none text-green-900 shadow-inner" placeholder="?">
                            <span class="font-bold text-green-900 text-xl" id="measure-unit">cm</span>
                        </div>
                        <button onclick="GameEngine.playClickAnd(MeasurementGame.checkAnswer, this)" class="ml-4 bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-2 px-8 rounded-full shadow-lg transform transition active:scale-95 border-b-4 border-green-800" id="measure-submit-btn">Jawab</button>
                    </div>
                </div>
            </div>

            <div id="game-geometry" class="game-module hidden">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold text-teal-800 mb-2">Galeri Pola Bambu</h3>
                    <p id="geometry-question" class="text-gray-600 text-lg font-semibold mb-2">Soal akan muncul di sini</p>
                    <p id="geometry-instruction" class="text-gray-500 text-sm">Pilih jawaban yang tepat!</p>
                </div>
                <div id="geometry-options" class="grid grid-cols-2 md:grid-cols-4 gap-4 justify-items-center"></div>
                <div class="text-center mt-8">
                    <button onclick="GameEngine.playClickAnd(GeometryGame.checkAnswer, this)" class="bg-teal-500 hover:bg-teal-600 text-white text-lg font-bold py-3 px-8 rounded-full shadow-lg transform transition active:scale-95">Cek Jawaban!</button>
                </div>
            </div>

            <div id="game-data" class="game-module hidden">
                <div class="text-center mb-6"><p class="text-lg text-gray-700">Perhatikan tabel hasil panen Pak Budi berikut.</p></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-purple-100 text-purple-800">
                                <tr><th class="p-3">Hari</th><th class="p-3 text-center">Jumlah Bambu</th></tr>
                            </thead>
                            <tbody id="data-table-body" class="text-gray-700"></tbody>
                        </table>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-xl border border-purple-200">
                        <p id="data-question" class="font-bold text-lg text-purple-900 mb-4">...</p>
                        <div id="data-options" class="flex flex-col gap-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div id="feedback-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 text-center shadow-2xl transform scale-100 transition-transform">
        <div id="feedback-icon" class="text-6xl mb-4">üåü</div>
        <h3 id="feedback-title" class="text-2xl font-bold mb-2">Hebat!</h3>
        <p id="feedback-msg" class="text-gray-600 mb-6">Jawabanmu benar sekali.</p>
        <button onclick="GameEngine.playClickAnd(GameEngine.closeModal, this)" class="bg-green-500 text-white px-6 py-2 rounded-full font-bold hover:bg-green-600 w-full">Lanjut</button>
    </div>
</div>

<audio id="click-sound" src="click.mp3.mp3" preload="auto"></audio>

<!-- Floating Home Button - Bottom Right -->
<a href="index.html" id="floating-home-btn" class="fixed bottom-6 right-6 z-50 flex items-center justify-center w-14 h-14 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-110 border-2 border-green-400" title="Kembali ke Beranda">
    <span class="text-2xl">üè†</span>
</a>

<audio id="sfx-success" src="sound/benar.mp3" preload="auto"></audio>
<audio id="sfx-fail" src="sound/salah.mp3" preload="auto"></audio>
<audio id="sfx-click-soft" src="click.mp3.mp3" preload="auto"></audio>
<audio id="sfx-zone-pop" src="click.mp3.mp3" preload="auto"></audio>

<script>
const Utils = {
    randomInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
    shuffle: (array) => {
        let currentIndex = array.length, randomIndex;
        while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    },
    playSound: (type) => {
        let audioId;
        if (type === 'success') audioId = 'sfx-success';
        else if (type === 'fail') audioId = 'sfx-fail';
        else if (type === 'click') audioId = 'sfx-click-soft';
        else if (type === 'zone') audioId = 'sfx-zone-pop';
        if (!audioId) return;
        const audio = document.getElementById(audioId);
        if (audio) {
            try { audio.currentTime = 0; audio.play(); } catch(e) {}
        }
    },
    buttonPressAnim(btn) {
        if (!btn) return;
        btn.classList.add('btn-press');
        setTimeout(() => btn.classList.remove('btn-press'), 140);
    }
};

const GameEngine = {
    currentLevel: null,
    xp: 0,
    level: 1,

    session: {
        limit: 10,
        sequences: { equation: [], geometry: [], data: [] },
        index: { sorting: 0, equation: 0, measurement: 0, geometry: 0, data: 0 }
    },

    startLevel: (type) => {
        document.getElementById('map-section').classList.add('hidden');
        document.getElementById('welcome-msg').classList.add('hidden');
        document.getElementById('game-area').classList.remove('hidden');
        document.querySelectorAll('.game-module').forEach(el => el.classList.add('hidden'));
        document.getElementById(`game-${type}`).classList.remove('hidden');
        GameEngine.currentLevel = type;

        if (['equation','geometry','data'].includes(type)) {
            GameEngine.ensureSessionSequence(type);
        }
        GameEngine.updateProgressUI();

        if (type === 'sorting') SortingGame.init();
        if (type === 'equation') EquationGame.init();
        if (type === 'measurement') MeasurementGame.init();
        if (type === 'geometry') GeometryGame.init();
        if (type === 'data') DataGame.init();

        const titles = {
            'sorting': 'Lembah Angka',
            'equation': 'Bengkel Bambu',
            'measurement': 'Taman Ukur',
            'geometry': 'Galeri Pola Bambu',
            'data': 'Balai Panen'
        };
        document.getElementById('game-title').innerText = titles[type];
    },

    handleZoneClick(type, ev) {
        const card = ev.currentTarget;
        card.classList.remove('zone-pop');
        void card.offsetWidth;
        card.classList.add('zone-pop');
        Utils.playSound('zone');
        setTimeout(() => GameEngine.startLevel(type), 140);
    },

    backToMap: () => {
        document.getElementById('game-area').classList.add('hidden');
        document.getElementById('map-section').classList.remove('hidden');
        document.getElementById('welcome-msg').classList.remove('hidden');
        GameEngine.currentLevel = null;
        GameEngine.updateProgressUI(true);
    },

    reloadLevel: () => {
        if (GameEngine.currentLevel) {
            GameEngine.startLevel(GameEngine.currentLevel);
        }
    },

    playClickAnd(action, btn) {
        Utils.playSound('click');
        Utils.buttonPressAnim(btn);
        setTimeout(() => { if (typeof action === 'function') action(); }, 80);
    },

    showFeedback: (isCorrect, message) => {
        const modal = document.getElementById('feedback-modal');
        const icon = document.getElementById('feedback-icon');
        const title = document.getElementById('feedback-title');
        const msg = document.getElementById('feedback-msg');
        const btn = modal.querySelector('button');

        btn.textContent = 'Lanjut';
        btn.onclick = () => GameEngine.playClickAnd(GameEngine.closeModal, btn);

        modal.classList.remove('hidden');
        if (isCorrect) {
            icon.innerText = 'üåü';
            title.innerText = 'Luar Biasa!';
            title.className = 'text-2xl font-bold mb-2 text-green-600';
            msg.innerText = message || 'Jawabanmu tepat sekali!';
            btn.className = 'bg-green-500 text-white px-6 py-2 rounded-full font-bold hover:bg-green-600 w-full';
            GameEngine.addXP(20);
            Utils.playSound('success');
        } else {
            icon.innerText = 'ü§î';
            title.innerText = 'Coba Lagi Yuk!';
            title.className = 'text-2xl font-bold mb-2 text-orange-500';
            msg.innerText = message || 'Masih belum tepat, jangan menyerah!';
            btn.className = 'bg-orange-500 text-white px-6 py-2 rounded-full font-bold hover:bg-orange-600 w-full';
            Utils.playSound('fail');
        }
    },

    closeModal: () => {
        document.getElementById('feedback-modal').classList.add('hidden');
    },

    addXP: (amount) => {
        GameEngine.xp += amount;
        if (GameEngine.xp >= 100) {
            GameEngine.xp = 0;
            GameEngine.level++;
            document.getElementById('level-indicator').innerText = GameEngine.level;
            const levelBubble = document.getElementById('level-indicator');
            levelBubble.classList.add('pop-anim');
            setTimeout(() => levelBubble.classList.remove('pop-anim'), 400);
        }
        document.getElementById('xp-bar').style.width = `${GameEngine.xp}%`;
    },

    ensureSessionSequence(gameType) {
        const seq = GameEngine.session.sequences[gameType];
        const idx = GameEngine.session.index[gameType];
        if (!seq.length || idx >= GameEngine.session.limit) {
            GameEngine.session.sequences[gameType] = GameEngine.buildQuestionSequence(gameType, GameEngine.session.limit);
            GameEngine.session.index[gameType] = 0;
        }
    },

    buildQuestionSequence(gameType, limit) {
        const pools = {
            equation: EquationGame.questionPool,
            geometry: GeometryGame.questionPool,
            data: DataGame.questionTypes
        };
        const pool = pools[gameType];
        if (!pool) return [];
        if (pool.length < limit) {
            console.warn(`[${gameType}] pool kurang dari ${limit}. Duplikat tidak bisa dihindari.`);
        }
        const indices = Array.from({length: pool.length}, (_, i) => i);
        Utils.shuffle(indices);
        const take = Math.min(limit, indices.length);
        return indices.slice(0, take);
    },

    nextFromSequence(gameType) {
        GameEngine.ensureSessionSequence(gameType);
        const idx = GameEngine.session.index[gameType];
        const qIndex = GameEngine.session.sequences[gameType][idx];
        GameEngine.session.index[gameType] = idx + 1;
        GameEngine.updateProgressUI();
        return qIndex;
    },

    canStartNextRound(gameType) {
        const idx = GameEngine.session.index[gameType] || 0;
        return idx < GameEngine.session.limit;
    },

    markCorrectAndAdvance(message) {
        const type = GameEngine.currentLevel;
        if ((GameEngine.session.index[type] || 0) >= GameEngine.session.limit) {
            GameEngine.showSessionComplete();
            return;
        }

        GameEngine.showFeedback(true, message);
        setTimeout(() => {
            GameEngine.closeModal();
            if ((GameEngine.session.index[type] || 0) >= GameEngine.session.limit) {
                GameEngine.showSessionComplete();
            } else {
                GameEngine.reloadLevel();
            }
        }, 1400);
    },

    showSessionComplete() {
        GameEngine.closeModal();
        const type = GameEngine.currentLevel;
        const titles = {
            sorting: 'Lembah Angka',
            equation: 'Bengkel Bambu',
            measurement: 'Taman Ukur',
            geometry: 'Galeri Pola Bambu',
            data: 'Balai Panen'
        };
        const name = titles[type] || 'Zona';
        GameEngine.showFeedback(true, `Sesi ${name} selesai! Kamu sudah menyelesaikan 10 soal. üéâ`);
        const modal = document.getElementById('feedback-modal');
        const btn = modal.querySelector('button');
        btn.textContent = 'Kembali ke Peta';
        btn.onclick = () => GameEngine.playClickAnd(() => {
            GameEngine.closeModal();
            GameEngine.backToMap();
        }, btn);

        if (['equation','geometry','data'].includes(type)) {
            GameEngine.session.index[type] = GameEngine.session.limit;
        } else {
            GameEngine.session.index[type] = GameEngine.session.limit;
        }
        GameEngine.updateProgressUI();
    },

    updateProgressUI(forceHide = false) {
        const el = document.getElementById('question-progress');
        if (!el) return;
        if (forceHide || !GameEngine.currentLevel) {
            el.classList.add('hidden');
            return;
        }
        const type = GameEngine.currentLevel;
        const shown = Math.max(1, Math.min(GameEngine.session.index[type] || 1, GameEngine.session.limit));
        el.textContent = `Soal ${shown}/${GameEngine.session.limit}`;
        el.classList.remove('hidden');
    }
};

// ====== Sorting Game ======
const SortingGame = {
    numbers: [],
    mode: 'order',
    container: null,
    titleEl: null,
    noteEl: null,
    config: {},
    idCounter: 0,
    draggedEl: null,
    init() {
        if (!GameEngine.canStartNextRound('sorting')) {
            GameEngine.showSessionComplete();
            return;
        }
        GameEngine.session.index.sorting = (GameEngine.session.index.sorting || 0) + 1;
        GameEngine.updateProgressUI();

        SortingGame.container = document.getElementById('sorting-container');
        SortingGame.titleEl = document.getElementById('sorting-title');
        SortingGame.noteEl = document.getElementById('sorting-note');
        SortingGame.pickMode();
        SortingGame.render();
    },
    pickMode() {
        const modes = ['order', 'repeat', 'division', 'compare'];
        SortingGame.mode = modes[Utils.randomInt(0, modes.length - 1)];
    },
    setInstruction(title, note) {
        if (SortingGame.titleEl) SortingGame.titleEl.innerText = title;
        if (SortingGame.noteEl) SortingGame.noteEl.innerText = note;
    },
    resetContainerGlow() {
        if (SortingGame.container) SortingGame.container.classList.remove('feedback-glow-success', 'feedback-glow-fail');
    },
    flashResult(isCorrect) {
        if (!SortingGame.container) return;
        SortingGame.resetContainerGlow();
        const cls = isCorrect ? 'feedback-glow-success' : 'feedback-glow-fail';
        SortingGame.container.classList.add(cls);
        setTimeout(() => SortingGame.container && SortingGame.container.classList.remove(cls), 900);
    },
    render() {
        if (!SortingGame.container) return;
        SortingGame.container.innerHTML = '';
        SortingGame.config = {};
        SortingGame.resetContainerGlow();
        if (SortingGame.mode === 'order') SortingGame.renderOrder();
        else if (SortingGame.mode === 'repeat') SortingGame.renderRepeat();
        else if (SortingGame.mode === 'division') SortingGame.renderDivision();
        else SortingGame.renderComparison();
    },
    renderOrder() {
        SortingGame.setInstruction('Urutkan bambu', 'Susun dari kecil ke besar.');
        const track = document.createElement('div');
        track.id = 'order-track';
        track.className = 'flex flex-wrap items-center justify-center gap-4 w-full';
        SortingGame.numbers = [];
        while (SortingGame.numbers.length < 5) {
            const n = Utils.randomInt(100, 999);
            if (!SortingGame.numbers.includes(n)) SortingGame.numbers.push(n);
        }
        SortingGame.numbers.forEach(num => {
            const card = document.createElement('div');
            card.className = 'draggable-item bg-green-100 border-2 border-green-400 text-green-800 font-bold text-2xl w-24 h-24 flex items-center justify-center rounded-xl shadow-md cursor-grab';
            card.draggable = true;
            card.innerText = num;
            card.dataset.value = num;
            card.id = SortingGame.generateId('order');
            card.addEventListener('dragstart', SortingGame.handleOrderDragStart);
            card.addEventListener('dragend', SortingGame.handleOrderDragEnd);
            track.appendChild(card);
        });
        track.addEventListener('dragover', SortingGame.handleOrderDragOver);
        SortingGame.container.appendChild(track);
    },
    renderRepeat() {
        const bundleSize = Utils.randomInt(2, 5);
        const bundlesNeeded = Utils.randomInt(2, 5);
        const extras = Utils.randomInt(1, 2);
        SortingGame.config = { bundleSize, bundlesNeeded };
        SortingGame.setInstruction('Isi peti bambu', 'Gunakan ikatan yang pas.');
        const supplyWrap = document.createElement('div');
        supplyWrap.className = 'w-full md:w-1/2 bg-white rounded-2xl border-2 border-green-100 p-4 flex flex-col gap-3';
        supplyWrap.innerHTML = `
            <h4 class="font-bold text-green-700 text-center">Ikatan Bambu</h4>
            <div id="bundle-supply" class="drop-slot min-h-[180px] bg-green-50 rounded-2xl flex flex-wrap items-center justify-center gap-3 p-3 bundle-zone"></div>
            <p class="text-xs text-center text-gray-500">Seret keluar-masuk bebas</p>
        `;
        const crateWrap = document.createElement('div');
        crateWrap.className = 'w-full md:w-1/2 bg-white rounded-2xl border-2 border-green-100 p-4 flex flex-col gap-3';
        crateWrap.innerHTML = `
            <h4 class="font-bold text-green-700 text-center">Peti Jumlah</h4>
            <div id="bundle-drop" class="drop-slot min-h-[180px] rounded-2xl flex flex-wrap items-center justify-center gap-3 p-3 bundle-zone">
                <span id="bundle-placeholder" class="text-sm text-gray-400">Taruh ikatan di sini</span>
            </div>
            <p class="text-sm text-center text-green-800 font-semibold">${bundlesNeeded} ikatan √ó ${bundleSize} bambu</p>
            <p class="text-xs text-center text-gray-500" id="bundle-count">Total: 0 bambu</p>
        `;
        SortingGame.container.appendChild(supplyWrap);
        SortingGame.container.appendChild(crateWrap);
        const supplyZone = document.getElementById('bundle-supply');
        const totalBundles = bundlesNeeded + extras;
        for (let i = 0; i < totalBundles; i++) supplyZone.appendChild(SortingGame.createBundleCard(bundleSize));
        const crateZone = document.getElementById('bundle-drop');
        [supplyZone, crateZone].forEach(zone => SortingGame.addZoneEvents(zone, SortingGame.bundleZoneDrop));
        SortingGame.updateBundleCount();
    },
    renderDivision() {
        const baskets = Utils.randomInt(2, 4);
        const perBasket = Utils.randomInt(2, 4);
        const total = baskets * perBasket;
        SortingGame.config = { baskets, perBasket, total };
        SortingGame.setInstruction('Bagikan bambu', 'Semua keranjang harus sama.');
        const left = document.createElement('div');
        left.className = 'w-full md:w-1/2 bg-white rounded-2xl border-2 border-green-100 p-4 flex flex-col gap-3';
        left.innerHTML = `
            <h4 class="font-bold text-green-700 text-center">Karung Bambu</h4>
            <div id="division-supply" class="drop-slot min-h-[200px] bg-green-50 rounded-2xl flex flex-wrap justify-center gap-2 p-3 chip-zone"></div>
            <p class="text-xs text-center text-gray-500">Seret ke keranjang</p>
        `;
        const right = document.createElement('div');
        right.className = 'w-full md:w-1/2 p-4 space-y-3';
        right.innerHTML = `
            <p class="text-center text-sm font-semibold text-green-800">Isi tiap keranjang: ${perBasket} bambu</p>
            <div id="basket-area" class="grid grid-cols-2 gap-4"></div>
        `;
        SortingGame.container.appendChild(left);
        SortingGame.container.appendChild(right);
        const supply = document.getElementById('division-supply');
        for (let i = 0; i < total; i++) supply.appendChild(SortingGame.createBambooChip());
        const basketArea = document.getElementById('basket-area');
        for (let b = 0; b < baskets; b++) {
            const wrap = document.createElement('div');
            wrap.className = 'bg-white rounded-3xl border-2 border-amber-200 p-4 flex flex-col items-center shadow-inner';
            wrap.innerHTML = `
                <div class="basket-drop drop-slot w-full min-h-[110px] rounded-2xl flex flex-wrap justify-center gap-2 p-2 chip-zone" data-basket="${b}"></div>
                <p class="mt-2 text-sm text-amber-700 font-bold" id="basket-count-${b}">0 bambu</p>
            `;
            basketArea.appendChild(wrap);
        }
        const basketZones = basketArea.querySelectorAll('.basket-drop');
        [supply, ...basketZones].forEach(zone => SortingGame.addZoneEvents(zone, SortingGame.chipZoneDrop));
        SortingGame.updateBasketCounts();
    },
    renderComparison() {
        const leftCount = Utils.randomInt(3, 9);
        let rightCount = Utils.randomInt(3, 9);
        if (Math.random() > 0.5) rightCount = leftCount;
        SortingGame.config = { leftCount, rightCount };
        SortingGame.setInstruction('Bandingkan kelompok bambu', 'Seret tanda yang tepat ke kotak di tengah.');
        
        const wrapper = document.createElement('div');
        wrapper.className = 'flex flex-col items-center gap-8 w-full';
        
        // Main comparison area - centered layout
        wrapper.innerHTML = `
            <div class="flex flex-col items-center gap-6 w-full">
                <!-- Groups and drop slot in a row -->
                <div class="flex items-center justify-center gap-6 md:gap-10 flex-wrap w-full">
                    <!-- Left group -->
                    <div class="group-board" id="group-left"></div>
                    
                    <!-- Center drop slot - more prominent -->
                    <div class="flex flex-col items-center gap-3">
                        <p class="text-sm font-bold text-amber-700">Taruh tanda di sini</p>
                        <div id="compare-slot" class="compare-slot drop-slot" data-symbol="">
                            <span class="text-5xl font-bold text-amber-400">?</span>
                        </div>
                        <p class="text-xs text-gray-500">‚¨áÔ∏è Seret dari bawah ‚¨áÔ∏è</p>
                    </div>
                    
                    <!-- Right group -->
                    <div class="group-board" id="group-right"></div>
                </div>
                
                <!-- Symbol bank - below and centered -->
                <div class="bg-blue-50 p-4 rounded-2xl border-2 border-blue-200 shadow-inner">
                    <p class="text-center text-sm font-bold text-blue-700 mb-3">Pilih Tanda Perbandingan:</p>
                    <div class="flex gap-4 justify-center" id="symbol-bank"></div>
                </div>
            </div>
        `;
        
        SortingGame.container.appendChild(wrapper);
        SortingGame.populateGroup('group-left', leftCount);
        SortingGame.populateGroup('group-right', rightCount);
        
        const bank = document.getElementById('symbol-bank');
        ['<', '>', '='].forEach(symbol => {
            const token = document.createElement('div');
            token.className = 'symbol-token draggable-item hover:scale-110 hover:shadow-lg transition-all cursor-grab';
            token.draggable = true;
            token.dataset.symbol = symbol;
            token.innerText = symbol;
            token.addEventListener('dragstart', SortingGame.handleSymbolDragStart);
            token.addEventListener('dragend', SortingGame.handleSymbolDragEnd);
            bank.appendChild(token);
        });
        
        const drop = document.getElementById('compare-slot');
        drop.addEventListener('dragover', SortingGame.allowDrop);
        drop.addEventListener('dragenter', () => drop.classList.add('drag-over'));
        drop.addEventListener('dragleave', () => drop.classList.remove('drag-over'));
        drop.addEventListener('drop', SortingGame.handleSymbolDrop);
    },
    populateGroup(id, count) {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const stick = document.createElement('span');
            stick.className = 'mini-bamboo';
            el.appendChild(stick);
        }
        const label = document.createElement('p');
        label.className = 'text-xs text-green-900 font-bold mt-2 w-full text-center';
        label.innerText = `${count} bambu`;
        el.appendChild(label);
    },
    createBundleCard(size) {
        const card = document.createElement('div');
        card.className = 'bundle-card draggable-item';
        card.draggable = true;
        card.dataset.size = size;
        card.dataset.dragtype = 'bundle';
        card.id = SortingGame.generateId('bundle');
        card.innerHTML = `
            <div class="text-3xl">üéç</div>
            <div class="flex flex-wrap gap-1 justify-center">${Array.from({ length: size }).map(() => '<span class="mini-bamboo"></span>').join('')}</div>
            <p class="text-xs font-bold text-green-900 mt-1">${size} bambu</p>
        `;
        card.addEventListener('dragstart', SortingGame.handleItemDragStart);
        card.addEventListener('dragend', SortingGame.handleItemDragEnd);
        return card;
    },
    createBambooChip() {
        const chip = document.createElement('div');
        chip.className = 'bamboo-chip';
        chip.draggable = true;
        chip.dataset.dragtype = 'chip';
        chip.id = SortingGame.generateId('chip');
        chip.addEventListener('dragstart', SortingGame.handleItemDragStart);
        chip.addEventListener('dragend', SortingGame.handleItemDragEnd);
        return chip;
    },
    addZoneEvents(zone, handler) {
        if (!zone) return;
        zone.addEventListener('dragover', SortingGame.allowDrop);
        zone.addEventListener('dragenter', () => zone.classList.add('drag-over'));
        zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
        zone.addEventListener('drop', (e) => { zone.classList.remove('drag-over'); handler.call(SortingGame, e, zone); });
    },
    allowDrop(e) { e.preventDefault(); },
    bundleZoneDrop(e, zone) {
        const id = e.dataTransfer.getData('text/plain');
        const el = document.getElementById(id);
        if (!el || el.dataset.dragtype !== 'bundle') return;
        zone.appendChild(el);
        Utils.playSound('click');
        SortingGame.updateBundleCount();
    },
    chipZoneDrop(e, zone) {
        const id = e.dataTransfer.getData('text/plain');
        const el = document.getElementById(id);
        if (!el || el.dataset.dragtype !== 'chip') return;
        zone.appendChild(el);
        Utils.playSound('click');
        SortingGame.updateBasketCounts();
    },
    updateBundleCount() {
        const crate = document.getElementById('bundle-drop');
        const placeholder = document.getElementById('bundle-placeholder');
        const info = document.getElementById('bundle-count');
        if (!crate) return;
        const placed = crate.querySelectorAll('.bundle-card').length;
        if (placeholder) placeholder.classList.toggle('hidden', placed > 0);
        if (info) info.innerText = `Total: ${placed * (SortingGame.config.bundleSize || 0)} bambu`;
    },
    updateBasketCounts() {
        const baskets = document.querySelectorAll('.basket-drop');
        baskets.forEach(basket => {
            const idx = basket.dataset.basket;
            const count = basket.querySelectorAll('.bamboo-chip').length;
            const label = document.getElementById(`basket-count-${idx}`);
            if (label) label.innerText = `${count} bambu`;
        });
    },
    handleOrderDragStart(e) {
        SortingGame.draggedEl = e.currentTarget;
        e.currentTarget.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', e.currentTarget.id);
        Utils.playSound('click');
    },
    handleOrderDragEnd(e) {
        e.currentTarget.classList.remove('dragging');
        SortingGame.draggedEl = null;
    },
    handleOrderDragOver(e) {
        e.preventDefault();
        const container = document.getElementById('order-track');
        const dragging = SortingGame.draggedEl;
        if (!container || !dragging) return;
        const afterElement = SortingGame.getDragAfterElement(container, e.clientX);
        if (afterElement == null) container.appendChild(dragging);
        else container.insertBefore(dragging, afterElement);
    },
    getDragAfterElement(container, x) {
        const elements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
        return elements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = x - box.left - box.width / 2;
            if (offset < 0 && offset > closest.offset) return { offset, element: child };
            return closest;
        }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
    },
    handleItemDragStart(e) {
        e.dataTransfer.setData('text/plain', e.currentTarget.id);
        e.dataTransfer.effectAllowed = 'move';
        e.currentTarget.classList.add('dragging');
        Utils.playSound('click');
    },
    handleItemDragEnd(e) { e.currentTarget.classList.remove('dragging'); },
    handleSymbolDragStart(e) {
        e.dataTransfer.setData('text/plain', e.currentTarget.dataset.symbol);
        e.dataTransfer.effectAllowed = 'copy';
        e.currentTarget.classList.add('dragging');
        Utils.playSound('click');
    },
    handleSymbolDragEnd(e) { e.currentTarget.classList.remove('dragging'); },
    handleSymbolDrop(e) {
        e.preventDefault();
        const symbol = e.dataTransfer.getData('text/plain');
        if (!symbol) return;
        const drop = document.getElementById('compare-slot');
        if (!drop) return;
        drop.innerHTML = `<span class="text-5xl font-bold text-blue-600">${symbol}</span>`;
        drop.dataset.symbol = symbol;
        drop.classList.add('has-symbol');
        Utils.playSound('click');
    },
    generateId(prefix) { SortingGame.idCounter += 1; return `${prefix}-${SortingGame.idCounter}`; },
    checkAnswer() {
        let result = false;
        let message = '';
        if (SortingGame.mode === 'order') {
            const container = document.getElementById('order-track');
            if (!container) return;
            const currentOrder = [...container.children].map(el => parseInt(el.dataset.value));
            const sorted = [...currentOrder].sort((a, b) => a - b);
            result = JSON.stringify(currentOrder) === JSON.stringify(sorted);
            message = result ? 'Urutan sudah pas!' : 'Masih ada yang belum urut.';
        } else if (SortingGame.mode === 'repeat') {
            const crate = document.getElementById('bundle-drop');
            if (!crate) return;
            const placed = crate.querySelectorAll('.bundle-card').length;
            if (placed === 0) {
                SortingGame.flashResult(false);
                GameEngine.showFeedback(false, 'Masukkan ikatan ke peti.');
                return;
            }
            result = placed === SortingGame.config.bundlesNeeded;
            message = result ? 'Total bambu tepat!' : 'Hitung lagi jumlah ikatannya.';
        } else if (SortingGame.mode === 'division') {
            const supply = document.getElementById('division-supply');
            const leftover = supply ? supply.querySelectorAll('.bamboo-chip').length : 0;
            const baskets = document.querySelectorAll('.basket-drop');
            const counts = [...baskets].map(b => b.querySelectorAll('.bamboo-chip').length);
            const target = SortingGame.config.perBasket;
            result = leftover === 0 && counts.every(c => c === target);
            if (leftover > 0) message = 'Masih ada bambu di karung.';
            else if (!counts.every(c => c === target)) message = 'Keranjang belum sama banyak.';
            else message = 'Pembagianmu adil!';
        } else {
            const drop = document.getElementById('compare-slot');
            if (!drop || !drop.dataset.symbol) {
                SortingGame.flashResult(false);
                GameEngine.showFeedback(false, 'Seret tanda ke kotak tengah dulu.');
                return;
            }
            const left = SortingGame.config.leftCount;
            const right = SortingGame.config.rightCount;
            const actual = left === right ? '=' : (left > right ? '>' : '<');
            result = actual === drop.dataset.symbol;
            message = result ? 'Perbandingannya tepat!' : 'Coba lihat lagi jumlah bambunya.';
        }
        SortingGame.flashResult(result);
        if (result) {
            GameEngine.markCorrectAndAdvance(message);
        } else {
            GameEngine.showFeedback(false, message);
        }
    }
};

// ====== Equation Game ======
const EquationGame = {
    currentQuestion: null,
    questionPool: [
        { text: 'Di Arboretum ada 24 bambu kuning. Lalu ditambah 15 bambu hitam. Kalimat matematikanya adalah‚Ä¶', options: ['24 √ó 15', '24 ‚Äì 15', '24 + 15', '24 √∑ 15'], answer: '24 + 15', type: 'add'},
        { text: 'Pak Budi menanam 125 bibit bambu di pagi hari, dan 110 bibit di sore hari. Berapa total bibit yang ditanam?', options: ['235', '15', '225', '245'], answer: '235', type: 'add' },
        { text: 'Di gudang ada 45 bambu petung dan 32 bambu apus. Berapa jumlah bambu seluruhnya?', options: ['77', '13', '80', '67'], answer: '77', type: 'add' },
        { text: 'Jika ada 40 tunas bambu lalu tumbuh lagi 29 tunas, kalimat matematikanya adalah‚Ä¶', options: ['40 ‚Äì 29', '29 ‚Äì 40', '40 + 29', '29 √∑ 40'], answer: '40 + 29', type: 'add'},
        { text: '32 + 18 menunjukkan...', options: ['Pengurangan jumlah bambu', 'Penjumlahan dua kelompok bambu', 'Pembagian bambu', 'Pengukuran bambu'], answer: 'Penjumlahan dua kelompok bambu', type: 'add' },
        { text: 'Di Arboretum terdapat 70 batang bambu petung. Setelah sebagian dipanen, tersisa 45 batang. Kalimat matematikanya adalah‚Ä¶', options: ['70 + 45', '70 ‚Äì 45', '70 √∑ 45', '70 √ó 45'], answer: '70 ‚Äì 45', type: 'sub' },
        { text: 'Ibu memiliki 500 tusuk sate bambu. Digunakan 250 tusuk untuk acara. Sisa tusuk sate adalah...', options: ['200', '300', '250', '750'], answer: '250', type: 'sub' },
        { text: 'Budi merawat kebun bambu. Di kebun itu terdapat 63 batang bambu. Setelah Budi menebang 19 batang, berapa bambu yang tersisa?', options: ['44', '42', '48', '50'], answer: '44', type: 'sub' },
        { text: '90 ‚Äì 37 artinya...', options: ['Mengurangi jumlah bambu sebanyak 37', 'Menambah bambu 37', 'Membagi bambu', 'Melipatgandakan bambu'], answer: 'Mengurangi jumlah bambu sebanyak 37', type: 'sub' },
        { text: 'Tinggi bambu A adalah 250 cm. Tinggi bambu B adalah 200 cm. Selisih tinggi mereka adalah...', options: ['50 cm', '450 cm', '25 cm', '100 cm'], answer: '50 cm', type: 'sub' },
        { text: 'Seorang petani memiliki 85 batang bambu. Ia menjual 38 batang ke pasar. Berapa batang bambu yang masih dimiliki petani?', options: ['47', '57', '37', '123'], answer: '47', type: 'sub'},
        { text: 'Ada 156 bambu di kebun A dan 78 bambu di kebun B. Total bambu dari kedua kebun adalah...', options: ['234', '78', '156', '244'], answer: '234', type: 'add'},
        { text: 'Rina mengumpulkan 220 tunas bambu pada bulan Januari dan 165 tunas pada bulan Februari. Berapa total tunas yang dikumpulkan Rina?', options: ['385', '55', '375', '395'], answer: '385', type: 'add'},
        { text: 'Sebuah toko memiliki 340 tusuk sate bambu. Terjual 185 tusuk. Berapa tusuk sate bambu yang tersisa di toko?', options: ['155', '165', '145', '525'], answer: '155', type: 'sub'},
        { text: 'Pak Tono menanam 99 pohon bambu tahun lalu dan 87 pohon bambu tahun ini. Berapa total pohon bambu yang ditanam Pak Tono?', options: ['186', '12', '176', '196'], answer: '186', type: 'add'},
        { text: 'Di sebuah arboretum ada 425 bambu. Kemudian ditanam lagi 238 bambu baru. Jumlah seluruh bambu sekarang adalah...', options: ['663', '187', '653', '673'], answer: '663', type: 'add'},
        { text: 'Siti memiliki 600 potongan bambu. Ia menggunakan 275 potongan untuk membuat kerajinan. Sisa potongan bambu Siti adalah...', options: ['325', '335', '315', '875'], answer: '325', type: 'sub'},
        { text: 'Dalam kompetisi, Tim A mengumpulkan 178 batang bambu dan Tim B mengumpulkan 234 batang bambu. Berapa total batang bambu yang dikumpulkan kedua tim?', options: ['412', '56', '402', '422'], answer: '412', type: 'add'},
        { text: 'Ada 750 bambu di hutan. Sebanyak 420 bambu ditebang untuk proyek. Berapa bambu yang masih ada di hutan?', options: ['330', '340', '320', '1170'], answer: '330', type: 'sub'},
        { text: 'Desa A memanen 567 batang bambu dan Desa B memanen 398 batang bambu. Total panen kedua desa adalah...', options: ['965', '169', '955', '975'], answer: '965', type: 'add'},
        { text: 'Perusahaan memiliki 888 tusuk bambu. Digunakan 456 tusuk untuk pesanan. Sisa tusuk bambu perusahaan adalah...', options: ['432', '442', '422', '1344'], answer: '432', type: 'sub'},
        { text: 'Kebun bambu memiliki 345 batang bambu kuning dan 278 batang bambu hijau. Berapa total batang bambu di kebun?', options: ['623', '67', '613', '633'], answer: '623', type: 'add'},
        { text: 'Ada 520 bibit bambu. Sebanyak 185 bibit berhasil tumbuh, sisanya mati. Berapa bibit yang mati?', options: ['335', '345', '325', '705'], answer: '335', type: 'sub'},
        { text: 'Pabrik memproduksi 680 anyaman bambu pada minggu pertama dan 425 anyaman pada minggu kedua. Total produksi dua minggu adalah...', options: ['1105', '255', '1095', '1115'], answer: '1105', type: 'add'},
        { text: 'Taman bambu memiliki 950 pengunjung. Setelah 378 orang pulang, berapa pengunjung yang masih ada?', options: ['572', '582', '562', '1328'], answer: '572', type: 'sub'},
        { text: 'Hutan bambu A memiliki 456 batang, hutan B memiliki 389 batang. Selisih jumlah bambu kedua hutan adalah...', options: ['67', '845', '77', '57'], answer: '67', type: 'sub'},
        { text: 'Seorang pengrajin membeli 230 batang bambu kecil dan 145 batang bambu besar. Berapa total batang bambu yang dibeli?', options: ['375', '85', '365', '385'], answer: '375', type: 'add'},
        { text: 'Ada 800 potongan bambu untuk dijual. Terjual 567 potongan. Berapa potongan yang belum terjual?', options: ['233', '243', '223', '1367'], answer: '233', type: 'sub'},
        { text: 'Petani A panen 299 bambu, petani B panen 356 bambu. Total panen kedua petani adalah...', options: ['655', '57', '645', '665'], answer: '655', type: 'add'},
        { text: 'Gudang menyimpan 675 batang bambu. Dikeluarkan 289 batang untuk proyek. Sisa bambu di gudang adalah...', options: ['386', '396', '376', '964'], answer: '386', type: 'sub'},
        { text: 'Sekolah membeli 188 batang bambu untuk pagar dan 267 batang untuk gazebo. Total bambu yang dibeli sekolah adalah...', options: ['455', '79', '445', '465'], answer: '455', type: 'add'}
    ],
    init() {
        const qIndex = GameEngine.nextFromSequence('equation');
        EquationGame.currentQuestion = EquationGame.questionPool[qIndex];
        EquationGame.render();
    },
    render() {
        const q = EquationGame.currentQuestion;
        const txtEl = document.getElementById('equation-question-text');
        const imgContainer = document.getElementById('equation-img-container');
        const imgEl = document.getElementById('equation-img');
        const optionsContainer = document.getElementById('equation-options-container');
        txtEl.innerText = q.text;
        if (q.image) {
            imgContainer.classList.remove('hidden');
            imgEl.src = q.image;
            imgEl.onerror = function() { this.src = 'https://cdn-icons-png.flaticon.com/512/2920/2920277.png'; };
        } else imgContainer.classList.add('hidden');

        optionsContainer.innerHTML = '';
        const shuffledOptions = Utils.shuffle([...q.options]);
        shuffledOptions.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'w-full text-left p-4 rounded-xl border-2 border-blue-200 bg-white hover:bg-blue-50 hover:border-blue-400 transition-all duration-200 shadow-sm flex items-center group';
            const circle = document.createElement('span');
            circle.className = 'w-8 h-8 rounded-full border-2 border-blue-300 mr-4 flex items-center justify-center text-blue-500 font-bold group-hover:bg-blue-500 group-hover:text-white transition-colors';
            circle.innerText = '?';
            const text = document.createElement('span');
            text.className = 'font-bold text-gray-700 text-lg group-hover:text-blue-800';
            text.innerText = opt;
            btn.appendChild(circle);
            btn.appendChild(text);
            btn.onclick = (ev) => {
                Utils.playSound('click');
                Utils.buttonPressAnim(ev.currentTarget);
                setTimeout(() => EquationGame.checkAnswer(opt), 90);
            };
            optionsContainer.appendChild(btn);
        });
    },
    checkAnswer(selectedVal) {
        const isCorrect = selectedVal === EquationGame.currentQuestion.answer;
        if (isCorrect) {
            GameEngine.markCorrectAndAdvance('Jawaban kamu tepat sekali!');
        } else {
            GameEngine.showFeedback(false, 'Hmm, coba baca lagi ceritanya pelan-pelan.');
        }
    }
};

// ====== Measurement Game ======
const MeasurementGame = {
    currentValue: 0,
    mode: 'length',
    PIXELS_PER_CM: 15,
    init() {
        if (!GameEngine.canStartNextRound('measurement')) {
            GameEngine.showSessionComplete();
            return;
        }
        GameEngine.session.index.measurement = (GameEngine.session.index.measurement || 0) + 1;
        GameEngine.updateProgressUI();

        const isLength = Math.random() > 0.5;
        MeasurementGame.mode = isLength ? 'length' : 'weight';
        if (isLength) MeasurementGame.startLengthGame();
        else MeasurementGame.startWeightGame();
    },
    startLengthGame() {
        document.getElementById('measure-length-game').classList.remove('hidden');
        document.getElementById('measure-weight-game').classList.add('hidden');
        document.getElementById('measure-question').innerText = 'Berapa panjang bambu ini?';
        document.getElementById('measure-hint').classList.remove('hidden');
        document.getElementById('measure-hint').innerHTML = '‚ÜîÔ∏è <b>Geser (Scroll) penggaris ke kanan</b> untuk melihat ujung bambu!<br><span class="text-xs text-gray-700">Garis besar = 10 cm, garis sedang = 5 cm, garis kecil = 1 cm, garis sangat kecil = 0,5 cm.</span>';
        document.getElementById('measure-label').innerText = 'Panjangnya adalah:';
        document.getElementById('measure-unit').innerText = 'cm';
        MeasurementGame.renderRulerTicks();
        const length = Utils.randomInt(15, 95);
        MeasurementGame.currentValue = length;
        const bamboo = document.getElementById('bamboo-obj');
        const input = document.getElementById('measure-input');
        const scrollArea = document.querySelector('#measure-length-game .overflow-x-auto');
        input.value = '';
        bamboo.style.width = '0px';
        setTimeout(() => {
            const widthPx = length * MeasurementGame.PIXELS_PER_CM;
            bamboo.style.width = widthPx + 'px';
            if (scrollArea) scrollArea.scrollLeft = 0;
        }, 200);
    },
    renderRulerTicks() {
        const rulerContainer = document.getElementById('ruler-ticks');
        rulerContainer.innerHTML = '';

        const maxCm = 100;
        for (let half = 0; half <= maxCm * 2; half++) {
            const cmVal = half / 2;
            const isWhole = Number.isInteger(cmVal);
            const isFive = isWhole && (cmVal % 5 === 0);
            const isTen = isWhole && (cmVal % 10 === 0);

            const tick = document.createElement('div');
            tick.style.position = 'absolute';
            tick.style.left = (cmVal * MeasurementGame.PIXELS_PER_CM) + 'px';
            tick.style.top = '0';
            tick.style.transform = 'translateX(-50%)';

            if (isTen) {
                tick.style.height = '26px';
                tick.style.backgroundColor = '#111827';
                tick.style.width = '2px';

                const label = document.createElement('span');
                label.innerText = cmVal;
                label.className = 'absolute top-7 left-1/2 transform -translate-x-1/2 font-bold text-sm text-gray-900';
                tick.appendChild(label);
            } else if (isFive) {
                tick.style.height = '18px';
                tick.style.backgroundColor = '#374151';
                tick.style.width = '1.5px';
            } else if (isWhole) {
                tick.style.height = '12px';
                tick.style.backgroundColor = '#6b7280';
                tick.style.width = '1px';
            } else {
                tick.style.height = '8px';
                tick.style.backgroundColor = '#9ca3af';
                tick.style.width = '1px';
            }

            rulerContainer.appendChild(tick);
        }
    },
    startWeightGame() {
        document.getElementById('measure-length-game').classList.add('hidden');
        document.getElementById('measure-weight-game').classList.remove('hidden');
        document.getElementById('measure-question').innerText = 'Berapa berat keranjang bambu ini?';
        const hintEl = document.getElementById('measure-hint');
        hintEl.classList.remove('hidden');
        hintEl.innerHTML = 'üí° <b>Info:</b> Garis angka = 1 kg. Garis sedang = 0,5 kg. Jawaban hanya boleh kelipatan 0,5 kg (misalnya 7,0 atau 7,5).';
        document.getElementById('measure-label').innerText = 'Beratnya adalah:';
        document.getElementById('measure-unit').innerText = 'kg';
        MeasurementGame.renderScaleTicks();

        const startAngle = 0;
        const endAngle = 330;
        const totalSpan = endAngle - startAngle;

        const step = Utils.randomInt(0, 20);
        const weight = step * 0.5;
        MeasurementGame.currentValue = weight;

        const needle = document.getElementById('scale-needle');
        const input = document.getElementById('measure-input');
        input.value = '';

        needle.style.transition = 'none';
        needle.style.transform = `translateX(-50%) rotate(${startAngle}deg)`;

        setTimeout(() => {
            needle.style.transition = 'transform 1.5s cubic-bezier(0.2, 0.8, 0.2, 1)';
            const fraction = step / 20;
            const targetAngle = startAngle + fraction * totalSpan;
            needle.style.transform = `translateX(-50%) rotate(${targetAngle}deg)`;
        }, 100);
    },
    renderScaleTicks() {
        const face = document.getElementById('scale-face');
        face.innerHTML = '';
        const radius = 180;
        const startAngle = 0;
        const endAngle = 330;
        const totalSpan = endAngle - startAngle;

        for (let step = 0; step <= 20; step++) {
            const val = step / 2;
            const fraction = step / 20;
            const angle = startAngle + fraction * totalSpan;

            const tick = document.createElement('div');
            tick.className = 'absolute bg-gray-800 origin-bottom';
            tick.style.top = '50%';
            tick.style.left = '50%';

            if (step % 2 === 0) {
                tick.style.width = '4px';
                tick.style.height = '30px';
                tick.style.backgroundColor = '#000';
                tick.style.transform = `translate(-50%, -50%) rotate(${angle}deg) translateY(-${radius - 30}px)`;

                const num = document.createElement('div');
                num.className = 'absolute font-bold text-gray-900 text-2xl flex items-center justify-center z-10';
                num.style.top = '50%';
                num.style.left = '50%';
                num.style.transform = `translate(-50%, -50%) rotate(${angle}deg) translateY(-${radius - 50}px) rotate(-${angle}deg)`;
                num.innerText = val;
                face.appendChild(num);
            } else {
                tick.style.width = '3px';
                tick.style.height = '22px';
                tick.style.backgroundColor = '#333';
                tick.style.transform = `translate(-50%, -50%) rotate(${angle}deg) translateY(-${radius - 24}px)`;
            }

            face.appendChild(tick);
        }
    },
    checkAnswer() {
        const input = document.getElementById('measure-input');
        const val = parseFloat(input.value);
        if (input.value === '') {
            GameEngine.showFeedback(false, 'Tulis dulu angkanya di kotak ya!');
            return;
        }
        const correct = MeasurementGame.currentValue;

        if (MeasurementGame.mode === 'weight') {
            if (isNaN(val)) {
                GameEngine.showFeedback(false, 'Isi dulu angkanya dengan benar ya.');
                return;
            }

            if ((val * 10) % 5 !== 0) {
                GameEngine.showFeedback(false, 'Jawaban harus kelipatan 0,5 kg (misalnya 7,0 atau 7,5).');
                return;
            }

            const userStr = val.toFixed(1);
            const correctStr = correct.toFixed(1);

            if (userStr === correctStr) {
                GameEngine.markCorrectAndAdvance(
                    `Hebat! Jarum menunjuk tepat ${correctStr} kg.`
                );
            } else {
                GameEngine.showFeedback(false, `Belum tepat. Jarum sebenarnya menunjuk ${correctStr} kg.`);
            }
            return;
        }

        const diff = Math.abs(val - correct);
        const isExact = diff < 0.0001;
        if (isExact) {
            const unit = 'cm';
            GameEngine.markCorrectAndAdvance(`Hebat! Jawabannya tepat ${val} ${unit}.`);
        } else {
            if (diff <= 1) GameEngine.showFeedback(false, 'Dikit lagi! Geser penggarisnya pelan-pelan.');
            else GameEngine.showFeedback(false, 'Masih kurang tepat. Coba ukur lagi.');
        }
    }
};

// ====== Geometry Game ======
const GeometryGame = {
    currentQuestion: null,
    selectedAnswer: null,
    questionPool: [
        { question: 'Manakah yang berbentuk PERSEGI?', instruction: 'Perhatikan sisi-sisinya, semua sama panjang dan pojoknya siku-siku.', options: [ { shape: 'square', label: '' }, { shape: 'circle', label: '' }, { shape: 'triangle', label: '' }, { shape: 'rectangle', label: '' } ], answer: 'square' },
        { question: 'Manakah yang berbentuk LINGKARAN?', instruction: 'Bangun ini tidak punya sudut dan sisinya melengkung.', options: [ { shape: 'circle', label: '' }, { shape: 'square', label: '' }, { shape: 'triangle', label: '' }, { shape: 'pentagon', label: '' } ], answer: 'circle' },
        { question: 'Manakah yang berbentuk SEGITIGA?', instruction: 'Bangun ini mempunyai 3 sisi dan 3 pojok.', options: [ { shape: 'triangle', label: '' }, { shape: 'square', label: '' }, { shape: 'hexagon', label: '' }, { shape: 'circle', label: '' } ], answer: 'triangle' },
        { question: 'Manakah yang memiliki 4 SISI SAMA PANJANG?', instruction: 'Bandingkan panjang semua sisinya.', options: [ { shape: 'square', label: '' }, { shape: 'rectangle', label: '' }, { shape: 'triangle', label: '' }, { shape: 'pentagon', label: '' } ], answer: 'square' },
        { question: 'Bangun datar yang TIDAK MEMILIKI SUDUT adalah...', instruction: 'Sudut adalah pojok yang dibentuk dua garis.', options: [ { shape: 'circle', label: '' }, { shape: 'square', label: '' }, { shape: 'triangle', label: '' }, { shape: 'rectangle', label: '' } ], answer: 'circle' },
        { question: 'Manakah yang berbentuk PERSEGI PANJANG?', instruction: 'Dua sisi berhadapan sama panjang dan semua pojok siku-siku.', options: [ { shape: 'rectangle', label: '' }, { shape: 'square', label: '' }, { shape: 'triangle', label: '' }, { shape: 'circle', label: '' } ], answer: 'rectangle' },
        { question: 'Bangun datar yang memiliki 5 SISI adalah...', instruction: 'Hitung jumlah garis pembentuk bangun.', options: [ { shape: 'pentagon', label: '' }, { shape: 'square', label: '' }, { shape: 'hexagon', label: '' }, { shape: 'triangle', label: '' } ], answer: 'pentagon' },
        { question: 'Bangun datar yang memiliki 6 SISI adalah...', instruction: 'Hitung jumlah garis pembentuk bangun.', options: [ { shape: 'hexagon', label: '' }, { shape: 'pentagon', label: '' }, { shape: 'square', label: '' }, { shape: 'triangle', label: '' } ], answer: 'hexagon' },
        { question: 'Bangun datar yang memiliki 3 POJOK adalah...', instruction: 'Hitung banyaknya pojok pada bangun.', options: [ { shape: 'triangle', label: '' }, { shape: 'square', label: '' }, { shape: 'rectangle', label: '' }, { shape: 'pentagon', label: '' } ], answer: 'triangle' },
        { question: 'Bangun datar yang memiliki 4 POJOK SIKU-SIKU adalah...', instruction: 'Pojok siku-siku membentuk sudut seperti pojok buku.', options: [ { shape: 'rectangle', label: '' }, { shape: 'triangle', label: '' }, { shape: 'pentagon', label: '' }, { shape: 'circle', label: '' } ], answer: 'rectangle' },
        { question: 'Manakah bangun dengan 5 SISI dan 5 POJOK?', instruction: 'Hitung sisi dan pojok pada tiap bangun.', options: [ { shape: 'pentagon', label: '' }, { shape: 'hexagon', label: '' }, { shape: 'square', label: '' }, { shape: 'triangle', label: '' } ], answer: 'pentagon' },
        { question: 'Manakah bangun dengan 6 SISI dan 6 POJOK?', instruction: 'Hitung sisi dan pojok pada tiap bangun.', options: [ { shape: 'hexagon', label: '' }, { shape: 'pentagon', label: '' }, { shape: 'rectangle', label: '' }, { shape: 'circle', label: '' } ], answer: 'hexagon' },
        { question: 'Perhatikan batang-batang bambu berikut. Klik pasangan batang yang arahnya sama dan tidak akan berpotongan.', instruction: 'Pilih struktur bambu yang menunjukkan dua batang searah.', options: [
            { shape: 'lines_parallel_horizontal', label: '' },
            { shape: 'lines_oblique_cross', label: '' },
            { shape: 'lines_perp_T', label: '' },
            { shape: 'lines_not_parallel_V', label: '' }
        ], answer: 'lines_parallel_horizontal' },
        { question: 'Manakah pasangan batang bambu yang saling sejajar?', instruction: 'Bandingkan arah kedua batang. Pilih yang selalu berjarak sama.', options: [
            { shape: 'lines_not_parallel_V', label: '' },
            { shape: 'lines_parallel_slanted', label: '' },
            { shape: 'lines_perp_corner', label: '' },
            { shape: 'lines_oblique_cross', label: '' }
        ], answer: 'lines_parallel_slanted' },
        { question: 'Perhatikan sambungan batang bambu berikut. Klik yang membentuk pojok siku-siku.', instruction: 'Pilih struktur bambu yang membentuk sudut seperti pojok meja.', options: [
            { shape: 'lines_perp_T', label: '' },
            { shape: 'lines_parallel_horizontal', label: '' },
            { shape: 'lines_oblique_cross', label: '' },
            { shape: 'lines_parallel_vertical', label: '' }
        ], answer: 'lines_perp_T' },
        { question: 'Manakah pertemuan dua batang bambu yang membentuk sudut siku-siku?', instruction: 'Cari pertemuan yang membentuk huruf L atau T.', options: [
            { shape: 'lines_oblique_cross', label: '' },
            { shape: 'lines_parallel_slanted', label: '' },
            { shape: 'lines_perp_corner', label: '' },
            { shape: 'lines_parallel_horizontal', label: '' }
        ], answer: 'lines_perp_corner' }
    ],
    init() {
        GeometryGame.selectedAnswer = null;
        GeometryGame.answered = false;
        const qIndex = GameEngine.nextFromSequence('geometry');
        GeometryGame.currentQuestion = GeometryGame.questionPool[qIndex];
        GeometryGame.render();
    },
    render() {
        const q = GeometryGame.currentQuestion;
        document.getElementById('geometry-question').innerText = q.question;
        document.getElementById('geometry-instruction').innerText = q.instruction;
        const container = document.getElementById('geometry-options');
        container.innerHTML = '';
        const shuffled = Utils.shuffle([...q.options]);
        shuffled.forEach((opt) => {
            const card = document.createElement('div');
            card.className = 'shape-card';
            card.dataset.shape = opt.shape;
            const visual = document.createElement('div');
            visual.className = 'shape-visual';
            visual.innerHTML = GeometryGame.getShapeSVG(opt.shape);
            const label = document.createElement('div');
            label.className = 'shape-label';
            label.innerText = opt.label;
            card.appendChild(visual);
            card.appendChild(label);
            card.onclick = () => {
                if (GeometryGame.answered) return;

                Utils.playSound('click');
                container.querySelectorAll('.shape-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                GeometryGame.selectedAnswer = opt.shape;

                GeometryGame.checkAnswer();
            };
            container.appendChild(card);
        });
    },
    getShapeSVG(shape) {
        const svgs = {
            square: '<svg viewBox="0 0 100 100" width="80" height="80"><rect x="10" y="10" width="80" height="80" fill="#4ade80" stroke="#15803d" stroke-width="3"/></svg>',
            rectangle: '<svg viewBox="0 0 100 100" width="80" height="80"><rect x="5" y="25" width="90" height="50" fill="#60a5fa" stroke="#1e40af" stroke-width="3"/></svg>',
            circle: '<svg viewBox="0 0 100 100" width="80" height="80"><circle cx="50" cy="50" r="40" fill="#fbbf24" stroke="#b45309" stroke-width="3"/></svg>',
            triangle: '<svg viewBox="0 0 100 100" width="80" height="80"><polygon points="50,15 90,85 10,85" fill="#f87171" stroke="#b91c1c" stroke-width="3"/></svg>',
            pentagon: '<svg viewBox="0 0 100 100" width="80" height="80"><polygon points="50,10 90,40 75,85 25,85 10,40" fill="#c084fc" stroke="#7c3aed" stroke-width="3"/></svg>',
            hexagon: '<svg viewBox="0 0 100 100" width="80" height="80"><polygon points="50,5 85,28 85,72 50,95 15,72 15,28" fill="#34d399" stroke="#059669" stroke-width="3"/></svg>',
            lines_parallel_horizontal:
                '<svg viewBox="0 0 100 100" width="80" height="80">\
                    <rect x="10" y="25" width="80" height="10" rx="5" fill="#16a34a" stroke="#065f46" stroke-width="2"/>\
                    <rect x="10" y="55" width="80" height="10" rx="5" fill="#16a34a" stroke="#065f46" stroke-width="2"/>\
                </svg>',
            lines_parallel_vertical:
                '<svg viewBox="0 0 100 100" width="80" height="80">\
                    <rect x="30" y="10" width="10" height="80" rx="5" fill="#16a34a" stroke="#065f46" stroke-width="2"/>\
                    <rect x="60" y="10" width="10" height="80" rx="5" fill="#16a34a" stroke="#065f46" stroke-width="2"/>\
                </svg>',
            lines_parallel_slanted:
                '<svg viewBox="0 0 100 100" width="80" height="80">\
                    <g stroke="#065f46" stroke-width="2" fill="#16a34a">\
                        <rect x="10" y="40" width="80" height="10" rx="5" transform="rotate(-20 50 50)"/>\
                        <rect x="10" y="40" width="80" height="10" rx="5" transform="rotate(-20 40 70)"/>\
                    </g>\
                </svg>',
            lines_not_parallel_V:
                '<svg viewBox="0 0 100 100" width="80" height="80">\
                    <rect x="45" y="15" width="10" height="70" rx="5" fill="#16a34a" stroke="#065f46" stroke-width="2" transform="rotate(-20 50 50)"/>\
                    <rect x="45" y="15" width="10" height="70" rx="5" fill="#16a34a" stroke="#065f46" stroke-width="2" transform="rotate(20 50 50)"/>\
                </svg>',
            lines_oblique_cross:
                '<svg viewBox="0 0 100 100" width="80" height="80">\
                    <rect x="45" y="10" width="10" height="80" rx="5" fill="#16a34a" stroke="#065f46" stroke-width="2" transform="rotate(30 50 50)"/>\
                    <rect x="45" y="10" width="10" height="80" rx="5" fill="#16a34a" stroke="#065f46" stroke-width="2" transform="rotate(-40 50 50)"/>\
                </svg>',
            lines_perp_T:
                '<svg viewBox="0 0 100 100" width="80" height="80">\
                    <rect x="45" y="10" width="10" height="80" rx="5" fill="#16a34a" stroke="#065f46" stroke-width="2"/>\
                    <rect x="20" y="40" width="60" height="10" rx="5" fill="#22c55e" stroke="#166534" stroke-width="2"/>\
                </svg>',
            lines_perp_corner:
                '<svg viewBox="0 0 100 100" width="80" height="80">\
                    <rect x="50" y="15" width="10" height="70" rx="5" fill="#16a34a" stroke="#065f46" stroke-width="2"/>\
                    <rect x="20" y="50" width="60" height="10" rx="5" fill="#22c55e" stroke="#166534" stroke-width="2"/>\
                </svg>'
        };
        return svgs[shape] || '';
    },
    checkAnswer() {
        if (GeometryGame.answered) return;

        if (!GeometryGame.selectedAnswer) {
            GameEngine.showFeedback(false, 'Pilih salah satu bangun datar dulu!');
            return;
        }

        GeometryGame.answered = true;

        const isCorrect = GeometryGame.selectedAnswer === GeometryGame.currentQuestion.answer;
        const cards = document.querySelectorAll('.shape-card');
        cards.forEach(card => {
            const shape = card.dataset.shape;
            card.classList.remove('correct', 'wrong');
            if (shape === GeometryGame.currentQuestion.answer) card.classList.add('correct');
            else if (shape === GeometryGame.selectedAnswer && !isCorrect) card.classList.add('wrong');
        });

        if (isCorrect) {
            Utils.playSound('success');
            GameEngine.showFeedback(true, 'Hebat! Kamu mengenali bentuknya dengan tepat!');
            setTimeout(GameEngine.reloadLevel, 2500);
        } else {
            Utils.playSound('fail');
            GameEngine.showFeedback(false, 'Coba perhatikan lagi ciri-ciri bangun datarnya.');
        }
    }
};

// ====== Data Game ======
const DataGame = {
    correctAnswer: null,
    questionTypes: [
        'max', 'min', 'sum', 'diff', 'count_above', 'count_below',
        'avg_compare', 'total_two', 'find_day', 'range'
    ],
    init() {
        const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];
        let values = [];
        while (values.length < 5) {
            let r = Utils.randomInt(15, 60);
            if (!values.includes(r)) values.push(r);
        }
        const data = days.map((d, i) => ({ day: d, val: values[i] }));
        const tbody = document.getElementById('data-table-body');
        tbody.innerHTML = '';
        data.forEach(row => {
            tbody.innerHTML += `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="p-3 font-medium">${row.day}</td>
                    <td class="p-3 text-center">${row.val}</td>
                </tr>
            `;
        });

        const qIndex = GameEngine.nextFromSequence('data');
        const qType = DataGame.questionTypes[qIndex];

        const questionText = document.getElementById('data-question');
        const optionsDiv = document.getElementById('data-options');
        optionsDiv.innerHTML = '';

        if (qType === 'max') {
            const maxVal = Math.max(...data.map(d => d.val));
            const maxDay = data.find(d => d.val === maxVal).day;
            DataGame.correctAnswer = maxDay;
            questionText.innerText = 'Pada hari apa panen bambu paling BANYAK?';
            days.forEach(d => DataGame.createOption(d, optionsDiv));
        } else if (qType === 'min') {
            const minVal = Math.min(...data.map(d => d.val));
            const minDay = data.find(d => d.val === minVal).day;
            DataGame.correctAnswer = minDay;
            questionText.innerText = 'Pada hari apa panen bambu paling SEDIKIT?';
            days.forEach(d => DataGame.createOption(d, optionsDiv));
        } else if (qType === 'sum') {
            const total = data.reduce((acc, d) => acc + d.val, 0);
            DataGame.correctAnswer = total;
            questionText.innerText = 'Berapa total panen bambu selama 5 hari?';
            const opts = new Set([total]);
            while (opts.size < 4) {
                const offset = Utils.randomInt(-30, 30);
                const val = total + offset;
                if (val > 0) opts.add(val);
            }
            Utils.shuffle(Array.from(opts)).forEach(o => DataGame.createOption(o, optionsDiv));
        } else if (qType === 'diff') {
            const maxVal = Math.max(...data.map(d => d.val));
            const minVal = Math.min(...data.map(d => d.val));
            const diff = maxVal - minVal;
            DataGame.correctAnswer = diff;
            questionText.innerText = 'Berapa selisih panen TERBANYAK dan TERSEDIKIT?';
            const opts = new Set([diff]);
            while (opts.size < 4) {
                const offset = Utils.randomInt(-10, 10);
                const val = diff + offset;
                if (val > 0 && val !== diff) opts.add(val);
            }
            Utils.shuffle(Array.from(opts)).forEach(o => DataGame.createOption(o, optionsDiv));
        } else if (qType === 'count_above') {
            const threshold = Utils.randomInt(30, 45);
            const count = data.filter(d => d.val > threshold).length;
            DataGame.correctAnswer = count;
            questionText.innerText = `Berapa hari panen bambu LEBIH DARI ${threshold} batang?`;
            [0, 1, 2, 3, 4, 5].forEach(o => DataGame.createOption(o, optionsDiv));
        } else if (qType === 'count_below') {
            const threshold = Utils.randomInt(35, 50);
            const count = data.filter(d => d.val < threshold).length;
            DataGame.correctAnswer = count;
            questionText.innerText = `Berapa hari panen bambu KURANG DARI ${threshold} batang?`;
            [0, 1, 2, 3, 4, 5].forEach(o => DataGame.createOption(o, optionsDiv));
        } else if (qType === 'avg_compare') {
            const avg = Math.round(data.reduce((acc, d) => acc + d.val, 0) / 5);
            const aboveAvg = data.filter(d => d.val > avg).length;
            DataGame.correctAnswer = aboveAvg;
            questionText.innerText = `Rata-rata panen adalah ${avg} batang. Berapa hari panen DI ATAS rata-rata?`;
            [0, 1, 2, 3, 4, 5].forEach(o => DataGame.createOption(o, optionsDiv));
        } else if (qType === 'total_two') {
            const idx1 = Utils.randomInt(0, 4);
            let idx2 = Utils.randomInt(0, 4);
            while (idx1 === idx2) idx2 = Utils.randomInt(0, 4);
            const sum = data[idx1].val + data[idx2].val;
            DataGame.correctAnswer = sum;
            questionText.innerText = `Berapa jumlah panen hari ${data[idx1].day} dan ${data[idx2].day}?`;
            const opts = new Set([sum]);
            while (opts.size < 4) {
                const offset = Utils.randomInt(-15, 15);
                const val = sum + offset;
                if (val > 0 && val !== sum) opts.add(val);
            }
            Utils.shuffle(Array.from(opts)).forEach(o => DataGame.createOption(o, optionsDiv));
        } else if (qType === 'find_day') {
            const targetVal = data[Utils.randomInt(0, 4)].val;
            const targetDay = data.find(d => d.val === targetVal).day;
            DataGame.correctAnswer = targetDay;
            questionText.innerText = `Pada hari apa panen bambu sebanyak ${targetVal} batang?`;
            days.forEach(d => DataGame.createOption(d, optionsDiv));
        } else {
            const sorted = [...data.map(d => d.val)].sort((a, b) => a - b);
            const range = sorted[sorted.length - 1] - sorted[0];
            DataGame.correctAnswer = range;
            questionText.innerText = 'Berapa RENTANG (jarak) antara panen terbanyak dan tersedikit?';
            const opts = new Set([range]);
            while (opts.size < 4) {
                const offset = Utils.randomInt(-8, 8);
                const val = range + offset;
                if (val > 0 && val !== range) opts.add(val);
            }
            Utils.shuffle(Array.from(opts)).forEach(o => DataGame.createOption(o, optionsDiv));
        }
    },
    createOption(val, container) {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-4 py-3 rounded border border-purple-200 bg-white hover:bg-purple-100 transition font-medium text-purple-900';
        btn.innerText = val;
        btn.onclick = (ev) => {
            Utils.playSound('click');
            Utils.buttonPressAnim(ev.currentTarget);
            setTimeout(() => DataGame.checkAnswer(val), 90);
        };
        container.appendChild(btn);
    },
    checkAnswer(val) {
        if (val == DataGame.correctAnswer) {
            GameEngine.showFeedback(true, 'Analisis datamu hebat!');
            setTimeout(GameEngine.reloadLevel, 2000);
        } else {
            GameEngine.showFeedback(false, 'Coba cek lagi angkanya di tabel.');
        }
    }
};

document.getElementById('floating-home-btn').addEventListener('click', function (e) {
    e.preventDefault(); // tahan navigasi

    const sound = document.getElementById('sfx-click-soft').cloneNode();
    sound.volume = 0.7;
    sound.play().catch(() => {});

    setTimeout(() => {
        window.location.href = this.href;
    }, 300);
});
</script>

</body>
</html>